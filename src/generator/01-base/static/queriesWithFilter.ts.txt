// Endpoint configurations
export type CountQuery<F> = {
    filter?: QueryFilter<F>;
    where?: QueryFilterNew<F> & CustomAttributeFilter;
    or?: (QueryFilter<F> & CustomAttributeFilter)[];
};


export type SomeQuery<
    E, // Entity
    F, // Entity filter
    I extends (QuerySelect<any> | undefined), // Select for referenced entities
    S extends (QuerySelect<any> | undefined), // Select for entity properties
    P extends string[] // Select for additional properties
> = {
    serializeNulls?: boolean;
    include?: I;
    properties?: P
    filter?: QueryFilter<F> & CustomAttributeFilter;
    where?: QueryFilterNew<F> & CustomAttributeFilter;
    select?: S;
    or?: (QueryFilter<F> & CustomAttributeFilter)[];
    sort?: Sort<E>[];
    pagination?: Pagination;
};

const _count = (
    cfg: ServiceConfig | undefined,
    endpoint: string,
    query?: CountQuery<any> & {params?: Record<any, any>}
) => wrapResponse(() => raw(cfg, endpoint, {
    unwrap: true,
    query: {
        ...flattenFilter(query?.filter),
        ...flattenOrFilter(query?.or),
        ...assembleFilterParam(query?.where),
        ...query?.params
    }
}));

const _some = (
    cfg: ServiceConfig | undefined,
    endpoint: string,
    query?: SomeQuery<any, any, any, any, any> & {params?: Record<any, any>}
) => wrapResponse(() => raw(cfg, endpoint, {
        query: {
            serializeNulls: query?.serializeNulls,
            additionalProperties: query?.properties?.join(','),
            properties: query?.select ? flattenSelect(query.select).join(',') : undefined,
            includeReferencedEntities: query?.include ? Object.keys(query.include).join(',') : undefined,
            ...flattenOrFilter(query?.or),
            ...flattenFilter(query?.filter),
            ...assembleFilterParam(query?.where),
            ...flattenSort(query?.sort),
            ...query?.params,
            ...query?.pagination
        }
    }).then(data => ({
        entities: data.result,
        references: data.referencedEntities ?? {},
        properties: data.additionalProperties ?? {}
    }))
);

const flattenFilter = (obj: QueryFilter<any> = {}): Record<string, string> => {
    const filter: [string, any][] = [], customAttributes: [string, any][] = [];

    Object.entries(obj).forEach(value => {
        (value[0].match(/^\d+$/) ? customAttributes : filter).push(value);
    });

    return Object.fromEntries([
        ...flatten(Object.fromEntries(filter)),
        ...flattenCustomAttributes(Object.fromEntries(customAttributes) as CustomAttributeFilter)
    ]);
};

const flattenOrFilter = (obj: QueryFilter<any>[] = []): Record<string, string> => {
    const entries: [string, any][] = [];

    for (let i = 0; i < obj.length; i++) {
        entries.push(
            ...flatten(obj[i])
                .map(v => [`or${i || ''}-${v[0]}`, v[1]]) as [string, string][]
        );
    }

    return Object.fromEntries(entries);
};